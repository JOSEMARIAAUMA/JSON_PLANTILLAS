{
  "name": "AI RAG Agent",
  "nodes": [
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('WhatsApp Trigger').item.json.messages[0].text.body }}",
        "options": {
          "systemMessage": "=## Role  \nYou're a helpful AI assistant that provides info about our company in a **natural, conversational way**. Think of yourself as a friendly colleague - knowledgeable but approachable.\n\n## How to Respond  \n1. **Read Between the Lines**  \n   - Look for both the direct question and what someone might *really* want to know\n   - Example: \"When do you close?\" ‚Üí Maybe they need urgent help before EOD\n\n2. **Find Info Smartly**  \n   - Search our Supabase docs like you're looking through a (very organized) filing cabinet\n   - Pull 2-3 relevant snippets but don't info-dump\n\n3. **Talk Like a Human**  \n   - Use contractions: \"We're\" instead of \"We are\"  \n   - Keep sentences short. Mix sentence lengths.  \n   - Add occasional phrases:  \n     - \"Good question!\"  \n     - \"Let me break that down...\"  \n     - \"Basically...\"  \n   \n4. **Keep It Real**  \n   - If info's missing: \"Hmm, I don't see that ‚Äì want me to connect you with Sarah from Support?\"  \n   - For complex topics: \"This gets a bit technical ‚Äì want the simple version or full details?\"\n\n## Examples  \n**User**: What's your return policy?  \n**You**: We want you to love what you buy! You can return items within 30 days ‚Äì just keep the tags on. Need help with a return? I can walk you through it or connect you to our returns team.\n\n**User**: How's your eco-friendly initiative going?  \n**You**: Great ask! We've recycled 12 tons of packaging this year ‚Äì that's like 3 elephants üêò! Our sustainability report just dropped, want the highlights or the full PDF?\n\n**User**: Tech specs for Model X?  \n**You**: Getting nerdy! *[lists specs]*. Translation: it's fast enough to make your laptop jealous. Need comparisons with other models?\n\n## Pro Tips  \n- **Troubleshooting**: \"Let's try this together...\" instead of \"Follow these steps\"  \n- **Apologies**: \"My bad ‚Äì let me check that again\" if correcting yourself  \n- **Encourage**: \"Still with me?\" after long explanations  \n- **Confidential**: \"That's under wraps ‚Äì but here's what I *can* share...\"  \n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        -340,
        -260
      ],
      "id": "9701aeb9-d076-460f-9051-61bce7e947da",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -580,
        80
      ],
      "id": "a34d1034-3f22-4276-b5e2-33ee522ac318",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "zhrWTjcPl2cmpeUE",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('WhatsApp Trigger').item.json.metadata.display_phone_number }}",
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryPostgresChat",
      "typeVersion": 1.3,
      "position": [
        -400,
        80
      ],
      "id": "23d07667-a2a9-40d1-a482-1bd6384826a3",
      "name": "Postgres Chat Memory",
      "credentials": {
        "postgres": {
          "id": "1mQGSRVHtL97Xco4",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9990c347-a664-46ad-9179-b41b895af863",
              "name": "sessionId",
              "value": "={{ $json.metadata.phone_number_id }}",
              "type": "string"
            },
            {
              "id": "3dda8a63-1683-4292-8bf0-57ff58080575",
              "name": "chatInput",
              "value": "={{ $json.messages[0].text.body }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -600,
        -260
      ],
      "id": "cdd8c797-9eb2-4e99-8923-cf3dea3fc21b",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "name": "company_info",
        "description": "Use this vector store to answer questions about our company"
      },
      "type": "@n8n/n8n-nodes-langchain.toolVectorStore",
      "typeVersion": 1,
      "position": [
        -80,
        -60
      ],
      "id": "7fc5fec1-4012-49e6-937e-2122349d4f97",
      "name": "Answer questions with a vector store"
    },
    {
      "parameters": {
        "tableName": {
          "__rl": true,
          "value": "documents",
          "mode": "list",
          "cachedResultName": "documents"
        },
        "options": {
          "queryName": "match_documents"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        -120,
        80
      ],
      "id": "55100e56-5932-4ec0-8f50-fd70a1c6bd6f",
      "name": "Supabase Vector Store",
      "credentials": {
        "supabaseApi": {
          "id": "FpZSrVauyVj3XZIE",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        260,
        140
      ],
      "id": "8a978c68-5668-4f13-aa9d-c4d89647d2b1",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "zhrWTjcPl2cmpeUE",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        -220,
        220
      ],
      "id": "7e16c8f8-eee2-4e1c-8788-b4856fdf2b98",
      "name": "Embeddings OpenAI",
      "credentials": {
        "openAiApi": {
          "id": "zhrWTjcPl2cmpeUE",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "updates": [
          "messages"
        ]
      },
      "type": "n8n-nodes-base.whatsAppTrigger",
      "typeVersion": 1,
      "position": [
        -860,
        -260
      ],
      "id": "b5925f2f-0293-48b7-b379-1ce94dfab671",
      "name": "WhatsApp Trigger",
      "webhookId": "66dc5364-91c9-410e-af51-fc1821747d3c",
      "credentials": {
        "whatsAppTriggerApi": {
          "id": "ljweofabRAWMnIo2",
          "name": "WhatsApp OAuth account"
        }
      }
    },
    {
      "parameters": {
        "operation": "send",
        "phoneNumberId": "486688084531413",
        "recipientPhoneNumber": "={{ $('WhatsApp Trigger').item.json.messages[0].from }}",
        "textBody": "={{ $json.output }}",
        "additionalFields": {},
        "requestOptions": {}
      },
      "type": "n8n-nodes-base.whatsApp",
      "typeVersion": 1,
      "position": [
        120,
        -260
      ],
      "id": "4844f28f-7dd1-418b-b086-d9803288a33c",
      "name": "WhatsApp Business Cloud",
      "credentials": {
        "whatsAppApi": {
          "id": "246swrirp04l3Zol",
          "name": "WhatsApp account"
        }
      }
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $('Set File Type&ID').item.json.file_type }}",
                    "rightValue": "application/pdf",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "PDF"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "bb719689-6fb4-4f3b-9ee5-fde5e01f1957",
                    "leftValue": "={{ $('Set File Type&ID').item.json.file_type }}",
                    "rightValue": "application/vnd.google-apps.document",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "doc"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "b85f433f-c3a9-4e96-931c-b47a37548003",
                    "leftValue": "={{ $('Set File Type&ID').item.json.file_type }}",
                    "rightValue": "application/vnd.google-apps.spreadsheet",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "CSV"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "6c266b6b-a6da-4ca1-b72d-1e25b63a000e",
                    "leftValue": "={{ $('Set File Type&ID').item.json.file_type }}",
                    "rightValue": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "XLSX"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -360,
        460
      ],
      "id": "d4488e2f-5310-49c2-ab46-9756d5aaa450",
      "name": "Switch"
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        140,
        880
      ],
      "id": "c59e1001-0892-4f3c-935c-8ce793c22353",
      "name": "Aggregate"
    },
    {
      "parameters": {
        "fieldsToSummarize": {
          "values": [
            {
              "aggregation": "concatenate",
              "field": "data"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.summarize",
      "typeVersion": 1.1,
      "position": [
        360,
        880
      ],
      "id": "689626e4-dc2d-4374-97bb-f22421fb9ad6",
      "name": "Summarize"
    },
    {
      "parameters": {
        "mode": "insert",
        "tableName": {
          "__rl": true,
          "value": "documents",
          "mode": "list",
          "cachedResultName": "documents"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.vectorStoreSupabase",
      "typeVersion": 1,
      "position": [
        640,
        380
      ],
      "id": "f489914b-25b8-49cc-a5af-d29b4863ef48",
      "name": "Supabase Vector Store1",
      "credentials": {
        "supabaseApi": {
          "id": "FpZSrVauyVj3XZIE",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        640,
        620
      ],
      "id": "bbb1b37a-3707-42ed-a302-6c9ecf145a98",
      "name": "Embeddings OpenAI1",
      "credentials": {
        "openAiApi": {
          "id": "zhrWTjcPl2cmpeUE",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "operation": "text",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        140,
        340
      ],
      "id": "a6019903-4667-4092-8b06-6a4c54cb7461",
      "name": "Extract from doc"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        140,
        520
      ],
      "id": "002618d1-337d-4309-9991-6e823b2d385b",
      "name": "Extract from CSV"
    },
    {
      "parameters": {
        "operation": "pdf",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        140,
        700
      ],
      "id": "c72c0579-3db8-45e7-9c59-4b042e66684f",
      "name": "Extract from PDF"
    },
    {
      "parameters": {
        "operation": "xlsx",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        -60,
        880
      ],
      "id": "4a303368-b292-47a6-86c1-f07811e383e6",
      "name": "Extract from XLSX"
    },
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        },
        "triggerOn": "specificFolder",
        "folderToWatch": {
          "__rl": true,
          "value": "1V9mZvLolrnrF_uxYSSNrkt23krGph_sD",
          "mode": "list",
          "cachedResultName": "Company KB",
          "cachedResultUrl": "https://drive.google.com/drive/folders/1V9mZvLolrnrF_uxYSSNrkt23krGph_sD"
        },
        "event": "fileCreated",
        "options": {}
      },
      "type": "n8n-nodes-base.googleDriveTrigger",
      "typeVersion": 1,
      "position": [
        -1400,
        400
      ],
      "id": "4af2f2a8-98ec-42c8-8a41-b4eaa0925f2b",
      "name": "File Created",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "uYZxwSrdADjaCPPG",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        },
        "triggerOn": "specificFolder",
        "folderToWatch": {
          "__rl": true,
          "value": "1V9mZvLolrnrF_uxYSSNrkt23krGph_sD",
          "mode": "list",
          "cachedResultName": "Company KB",
          "cachedResultUrl": "https://drive.google.com/drive/folders/1V9mZvLolrnrF_uxYSSNrkt23krGph_sD"
        },
        "event": "fileUpdated",
        "options": {}
      },
      "type": "n8n-nodes-base.googleDriveTrigger",
      "typeVersion": 1,
      "position": [
        -1400,
        620
      ],
      "id": "b2f79b9d-c6c1-4d67-b45c-817dd9153595",
      "name": "File Updated",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "uYZxwSrdADjaCPPG",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "value": "={{ $('Set File Type&ID').item.json.file_id }}",
          "mode": "id"
        },
        "options": {
          "googleFileConversion": {
            "conversion": {
              "docsToFormat": "text/plain"
            }
          }
        }
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -620,
        500
      ],
      "id": "8e562f13-3dd4-4101-8b8a-5f707619bccd",
      "name": "Download New File",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "uYZxwSrdADjaCPPG",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "operation": "delete",
        "tableId": "documents",
        "filterType": "string",
        "filterString": "=metadata->>file_id=like.*{{ $json.file_id }}*"
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -860,
        500
      ],
      "id": "3f9d0592-08d1-42fc-9aa2-e62afe89e426",
      "name": "Delete Old File Version",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "FpZSrVauyVj3XZIE",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "6df1e25e-690d-4658-b46b-9b9dbb388c80",
              "name": "file_id",
              "value": "={{ $json.id }}",
              "type": "string"
            },
            {
              "id": "a9a3dcb9-3641-4ee2-93de-957dffa574bc",
              "name": "file_type",
              "value": "={{ $json.mimeType }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1080,
        500
      ],
      "id": "3843f066-609b-4144-8cc2-36cffadbe373",
      "name": "Set File Type&ID"
    },
    {
      "parameters": {
        "dataType": "binary",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1,
      "position": [
        760,
        580
      ],
      "id": "068bcfec-2c8b-4fab-b4af-35b3fc5cbc73",
      "name": "Default Data Loader"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.textSplitterCharacterTextSplitter",
      "typeVersion": 1,
      "position": [
        840,
        800
      ],
      "id": "ca80088a-4f6f-434a-9503-51fbfc6e0e35",
      "name": "Character Text Splitter"
    }
  ],
  "pinData": {},
  "connections": {
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Postgres Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Answer questions with a vector store": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Supabase Vector Store": {
      "ai_vectorStore": [
        [
          {
            "node": "Answer questions with a vector store",
            "type": "ai_vectorStore",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Answer questions with a vector store",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI": {
      "ai_embedding": [
        [
          {
            "node": "Supabase Vector Store",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "WhatsApp Trigger": {
      "main": [
        [
          {
            "node": "Edit Fields",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "WhatsApp Business Cloud",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Extract from PDF",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract from doc",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract from CSV",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract from XLSX",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract from doc",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate": {
      "main": [
        [
          {
            "node": "Summarize",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Summarize": {
      "main": [
        [
          {
            "node": "Supabase Vector Store1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI1": {
      "ai_embedding": [
        [
          {
            "node": "Supabase Vector Store1",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Extract from doc": {
      "main": [
        [
          {
            "node": "Supabase Vector Store1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from CSV": {
      "main": [
        [
          {
            "node": "Supabase Vector Store1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from PDF": {
      "main": [
        [
          {
            "node": "Supabase Vector Store1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from XLSX": {
      "main": [
        [
          {
            "node": "Aggregate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "File Created": {
      "main": [
        [
          {
            "node": "Set File Type&ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "File Updated": {
      "main": [
        [
          {
            "node": "Set File Type&ID",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download New File": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Delete Old File Version": {
      "main": [
        [
          {
            "node": "Download New File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set File Type&ID": {
      "main": [
        [
          {
            "node": "Delete Old File Version",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Default Data Loader": {
      "ai_document": [
        [
          {
            "node": "Supabase Vector Store1",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    },
    "Character Text Splitter": {
      "ai_textSplitter": [
        [
          {
            "node": "Default Data Loader",
            "type": "ai_textSplitter",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "7129b441-1e3d-458e-aa49-96d52b44b05d",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "0b74d5f95588deee115b9453d790a058b1d11cd310c9b425bf8b56a98c8624ea"
  },
  "id": "7egboEYvn8euOTgD",
  "tags": []
}